<!DOCTYPE html>
<html>
<!-- ==========================================================================
     Sahar Stays: Hotel booking site with agentic AI chat (React + PHP + Python).
     ========================================================================== -->

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sahar Stays | Luxury Hotel Booking</title>
    <!-- React & ReactDOM (UMD build for in-browser use) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel: transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS (utility-first styles) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* Base font from Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        /* Reset: no default margins/padding, box-sizing for consistent sizing */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        /* Page background and font */
        body {
            font-family: 'Inter', sans-serif;
            background: #f4f4f5;
            min-height: 100vh;
        }
        /* Class used on body for background */
        .animated-bg {
            background: #f4f4f5;
        }
        /* Card style: white with light border (nav, buttons) */
        .glass {
            background: white;
            border: 1px solid #e4e4e7;
        }
        /* Stronger card (chat panel, hotel cards) */
        .glass-strong {
            background: white;
            border: 1px solid #e4e4e7;
        }
        html {
            scroll-behavior: smooth;
        }
        /* Custom scrollbar width */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f4f4f5;
        }
        ::-webkit-scrollbar-thumb {
            background: #d4d4d8;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1aa;
        }
        /* Chat panel show/hide transition */
        .chat-widget {
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        .chat-open {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }
        .chat-closed {
            opacity: 0;
            transform: translateY(30px) scale(0.9);
            pointer-events: none;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        .float-animation {
            animation: float 6s ease-in-out infinite;
        }
        /* Message / card entrance animation */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
        }
        .pulse-animation {
            /* no pulse for simple design */
        }
        .card-hover {
            transition: all 0.2s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
        }
    </style>
</head>

<body class="animated-bg">
    <!-- React root: entire app is rendered here -->
    <div id="root"></div>

    <script type="text/babel">
        // =====================================================================
        // ChatWidget: floating chat panel. Sends messages to api.php, shows
        // bot replies, and calls onUiAction when response includes ui_action.
        // =====================================================================
        function ChatWidget({ isOpen, onClose, initialMessage, onMessageSent, onUiAction }) {
            // Initial bot greeting
            const [messages, setMessages] = React.useState([
                { sender: 'bot', text: "Hello! I'm your AI Concierge. How can I help you plan your perfect stay?" }
            ]);
            const [input, setInput] = React.useState("");
            const [loading, setLoading] = React.useState(false);
            // Unique session id for this tab (used by api.php to load/save conversation)
            const [sessionId] = React.useState("sess_" + Math.random().toString(36).substr(2, 9));
            const messagesEndRef = React.useRef(null);
            const inputRef = React.useRef(null);

            // When parent passes a prefill message (e.g. from "Book This Room"), put it in input and focus
            React.useEffect(() => {
                if (initialMessage) {
                    setInput(initialMessage);
                    inputRef.current?.focus();
                }
            }, [initialMessage]);

            // Scroll to bottom when new messages are added
            React.useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages]);

            // Send user message to api.php, then append bot reply and apply ui_action
            const sendMessage = async (textOverride = null) => {
                const userMsg = textOverride || input;
                if (!userMsg.trim()) return;

                setMessages(prev => [...prev, { sender: 'user', text: userMsg }]);
                setInput("");
                setLoading(true);
                if (onMessageSent) onMessageSent();

                try {
                    const response = await fetch('api.php', {
                        method: 'POST',
                        body: JSON.stringify({ session_id: sessionId, message: userMsg })
                    });
                    const text = await response.text();

                    try {
                        const data = JSON.parse(text);
                        if (data.error) throw new Error(data.error);

                        let botText = data.text || data.response || "I received an empty response.";
                        setMessages(prev => [...prev, { sender: 'bot', text: botText }]);

                        if (data.ui_action && onUiAction) {
                            onUiAction(data.ui_action);
                        }
                    } catch (e) {
                        setMessages(prev => [...prev, { sender: 'bot', text: text }]);
                    }
                } catch (error) {
                    setMessages(prev => [...prev, { sender: 'bot', text: "Sorry, I'm having trouble connecting." }]);
                }
                setLoading(false);
            };

            return (
                <div className={`fixed bottom-24 right-6 w-96 h-[550px] rounded-3xl shadow-2xl flex flex-col overflow-hidden z-50 chat-widget glass-strong ${isOpen ? 'chat-open' : 'chat-closed'}`}>
                    {/* Chat header: title and close button */}
                    <div className="bg-slate-800 p-5 flex justify-between items-center text-white">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-full bg-slate-600 flex items-center justify-center">
                                <i className="ph-fill ph-sparkle text-xl"></i>
                            </div>
                            <div>
                                <span className="font-bold text-lg">AI Concierge</span>
                                <p className="text-xs text-slate-300">Always here to help</p>
                            </div>
                        </div>
                        <button onClick={onClose} className="hover:bg-slate-700 p-2 rounded-full transition-colors">
                            <i className="ph ph-x text-xl"></i>
                        </button>
                    </div>

                    {/* Scrollable message list: user right, bot left */}
                    <div className="flex-1 overflow-y-auto p-5 space-y-4" style={{ scrollbarWidth: 'thin' }}>
                        {messages.map((msg, idx) => (
                            <div key={idx} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'} fade-in-up`} style={{ animationDelay: `${idx * 0.1}s` }}>
                                <div className={`max-w-[85%] p-4 rounded-2xl text-sm leading-relaxed ${msg.sender === 'user' ? 'bg-slate-800 text-white rounded-tr-none shadow-sm' : 'bg-white text-gray-800 rounded-tl-none shadow-sm border border-gray-200'}`} style={{ whiteSpace: 'pre-wrap' }}>
                                    {msg.text}
                                </div>
                            </div>
                        ))}
                        {/* Loading indicator: three bouncing dots */}
                        {loading && (
                            <div className="flex justify-start">
                                <div className="bg-white p-4 rounded-2xl rounded-tl-none shadow-md">
                                    <div className="flex gap-1">
                                        <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                                        <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.1s' }}></div>
                                        <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.2s' }}></div>
                                    </div>
                                </div>
                            </div>
                        )}
                        <div ref={messagesEndRef} />
                    </div>

                    {/* Input row: text field and send button */}
                    <div className="p-4 bg-white border-t border-gray-100">
                        <div className="flex gap-2">
                            <input
                                ref={inputRef}
                                className="flex-1 p-3 bg-gray-50 rounded-xl focus:outline-none focus:ring-2 focus:ring-slate-400 text-sm transition-all border border-gray-200"
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                                placeholder="Type your message..."
                            />
                            <button
                                disabled={loading}
                                onClick={() => sendMessage()}
                                className="bg-slate-800 text-white p-3 rounded-xl hover:bg-slate-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                <i className="ph-fill ph-paper-plane-right text-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // =====================================================================
        // HotelCard: one card per hotel (image, name, price, room selector, Book button).
        // Clicking card opens details; Book opens chat with prefill message.
        // =====================================================================
        function HotelCard({ hotel, onBook, onViewDetails }) {
            const [selectedRoom, setSelectedRoom] = React.useState(Object.keys(hotel.room_types)[0] || "Standard");

            return (
                <div className="glass-strong rounded-2xl overflow-hidden shadow-xl hover:shadow-2xl transition-all card-hover fade-in-up">
                    {/* Image area: click to view details; overlay shows "View Details" on hover */}
                    <div
                        className="h-56 overflow-hidden relative cursor-pointer group"
                        onClick={() => onViewDetails && onViewDetails(hotel)}
                    >
                        <img src={hotel.image_url} alt={hotel.name} className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700" />
                        <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>
                        <div className="absolute top-4 right-4 bg-white/95 backdrop-blur px-3 py-1.5 rounded-full text-sm font-bold text-gray-800 shadow-lg flex items-center gap-1">
                            <i className="ph-fill ph-star text-yellow-500"></i>
                            {hotel.rating}
                        </div>
                        <div className="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-all flex items-center justify-center opacity-0 group-hover:opacity-100">
                            <span className="bg-white text-gray-900 px-6 py-3 rounded-full text-sm font-bold shadow-2xl transform translate-y-4 group-hover:translate-y-0 transition-transform">
                                View Details →
                            </span>
                        </div>
                    </div>
                    <div className="p-6 flex flex-col flex-1">
                        <div className="flex justify-between items-start mb-3">
                            <h3 className="text-2xl font-bold text-gray-900">{hotel.name}</h3>
                            <span className="text-slate-800 font-bold bg-slate-100 px-3 py-1.5 rounded-full text-sm">
                                {hotel.room_types[selectedRoom]}€
                            </span>
                        </div>
                        <p className="text-gray-600 text-sm mb-5 line-clamp-2">{hotel.context}</p>

                        <div className="mt-auto space-y-3">
                            {/* Dropdown to pick room type; price updates from hotel.room_types */}
                            <div className="text-sm">
                                <label className="block text-gray-500 text-xs mb-2 font-semibold uppercase tracking-wider">Room Type</label>
                                <select
                                    className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:border-slate-400 text-gray-700 transition-all"
                                    value={selectedRoom}
                                    onChange={(e) => setSelectedRoom(e.target.value)}
                                >
                                    {Object.entries(hotel.room_types).map(([type, price]) => (
                                        <option key={type} value={type}>{type} ({price}€)</option>
                                    ))}
                                </select>
                            </div>

                            <button
                                onClick={() => onBook(hotel, selectedRoom)}
                                className="w-full bg-slate-800 text-white py-3 rounded-xl font-semibold hover:bg-slate-700 transition-all"
                            >
                                Book This Room
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // =====================================================================
        // HotelDetails: full page for one hotel (image, amenities, calendar, room list).
        // Fetches booked date ranges for calendar; "Select" / Book opens chat with prefill.
        // =====================================================================
        function HotelDetails({ hotel, onBack, onBook }) {
            const [bookedRanges, setBookedRanges] = React.useState([]);

            React.useEffect(() => {
                fetch(`api_availability.php?hotel_id=${hotel.id}`)
                    .then(r => r.json())
                    .then(data => {
                        if (Array.isArray(data)) setBookedRanges(data);
                    })
                    .catch(e => console.error("Failed to load availability", e));
            }, [hotel.id]);

            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();

            /** True if this calendar day falls inside any booked range from api_availability */
            const isDateBooked = (day) => {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                return bookedRanges.some(range => {
                    return dateStr >= range.check_in && dateStr < range.check_out;
                });
            };

            return (
                <div className="max-w-7xl mx-auto px-6 py-10 fade-in-up">
                    <button onClick={onBack} className="bg-white border border-gray-200 text-gray-700 px-6 py-3 rounded-xl flex items-center gap-2 hover:bg-gray-50 mb-8 transition-all font-semibold">
                        <i className="ph-bold ph-arrow-left"></i> Back to Hotels
                    </button>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-12">
                        {/* Left: Image & Info */}
                        <div>
                            <div className="h-[450px] rounded-3xl overflow-hidden shadow-2xl mb-8 relative group">
                                <img src={hotel.image_url} alt={hotel.name} className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700" />
                                <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>
                                <div className="absolute top-6 right-6 bg-white/95 backdrop-blur px-4 py-2 rounded-full text-sm font-bold shadow-lg flex items-center gap-2">
                                    <i className="ph-fill ph-star text-yellow-500"></i>
                                    {hotel.rating}
                                </div>
                            </div>

                            <h1 className="text-5xl font-bold text-gray-900 mb-3">{hotel.name}</h1>
                            <p className="text-2xl text-gray-600 mb-6 flex items-center gap-2">
                                <i className="ph-fill ph-map-pin text-slate-500"></i> {hotel.city}
                            </p>
                            <p className="text-gray-600 leading-relaxed mb-8 text-lg">{hotel.context}</p>

                            <h3 className="text-2xl font-bold text-gray-900 mb-4">Amenities</h3>
                            <div className="flex flex-wrap gap-3 mb-8">
                                {hotel.amenities.map(amenity => (
                                    <span key={amenity} className="bg-slate-100 text-slate-700 px-5 py-2.5 rounded-full text-sm font-medium flex items-center gap-2 border border-slate-200">
                                        <i className="ph-fill ph-check-circle text-slate-500"></i> {amenity}
                                    </span>
                                ))}
                            </div>
                        </div>

                        {/* Right column: calendar (booked days from API) and room types with Select */}
                        <div className="glass-strong p-8 rounded-3xl shadow-2xl h-fit">
                            <h3 className="text-3xl font-bold mb-6 text-gray-900">Availability & Rooms</h3>

                            {/* Month calendar: red = booked, slate = available */}
                            <div className="mb-8">
                                <h4 className="font-semibold text-gray-700 mb-4 flex justify-between items-center">
                                    <span className="text-lg">{today.toLocaleString('default', { month: 'long', year: 'numeric' })}</span>
                                    <span className="text-xs font-normal text-gray-500 px-3 py-1 bg-red-50 rounded-full flex items-center gap-1">
                                        <div className="w-2 h-2 bg-red-500 rounded-full"></div>
                                        Booked
                                    </span>
                                </h4>
                                <div className="grid grid-cols-7 gap-2 text-center text-sm">
                                    {['S', 'M', 'T', 'W', 'T', 'F', 'S'].map(d => <div key={d} className="text-gray-500 font-semibold py-2">{d}</div>)}
                                    {Array(firstDayOfMonth).fill(null).map((_, i) => <div key={`empty-${i}`} />)}
                                    {Array(daysInMonth).fill(null).map((_, i) => {
                                        const day = i + 1;
                                        const booked = isDateBooked(day);
                                        return (
                                            <div
                                                key={day}
                                                className={`py-3 rounded-xl font-medium transition-all ${booked ? 'bg-red-50 text-red-500 cursor-not-allowed' : 'bg-slate-100 text-slate-700 hover:bg-slate-200 cursor-pointer'}`}
                                                title={booked ? "Unavailable" : "Available"}
                                            >
                                                {day}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            {/* List of room types with price and Select button (opens chat to book) */}
                            <div className="space-y-4">
                                {Object.entries(hotel.room_types).map(([type, price]) => (
                                    <div key={type} className="flex items-center justify-between p-5 border border-gray-200 rounded-2xl hover:border-slate-300 transition-all bg-gray-50 hover:bg-gray-100">
                                        <div>
                                            <span className="font-bold text-gray-900 block text-lg">{type}</span>
                                            <span className="text-sm text-gray-500">Includes breakfast & wifi</span>
                                        </div>
                                        <div className="flex items-center gap-4">
                                            <span className="text-2xl font-bold text-slate-800">{price}€</span>
                                            <button
                                                onClick={() => onBook(hotel, type)}
                                                className="bg-slate-800 text-white px-6 py-2.5 rounded-xl text-sm font-semibold hover:bg-slate-700 transition-all"
                                            >
                                                Select
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // =====================================================================
        // App: layout (nav, hero, hotel list or hotel details), chat button, ChatWidget.
        // State: hotels from api_hotels.php; activeCity/selectedHotelId driven by ui_action.
        // =====================================================================
        function App() {
            const [isChatOpen, setIsChatOpen] = React.useState(false);
            const [hotels, setHotels] = React.useState([]);
            const [pendingMessage, setPendingMessage] = React.useState("");
            const [activeCity, setActiveCity] = React.useState("All");
            const [selectedHotelId, setSelectedHotelId] = React.useState(null);

            React.useEffect(() => {
                fetch('api_hotels.php')
                    .then(r => r.json())
                    .then(data => setHotels(data))
                    .catch(e => console.error("Failed to load hotels", e));
            }, []);

            /** Open chat and prefill with "I would like to book the X at Y" */
            const handleBookClick = (hotel, roomType) => {
                setIsChatOpen(true);
                setPendingMessage(`I would like to book the ${roomType} at ${hotel.name}.`);
            };

            /** Apply ui_action from agent response: filter by city or open hotel details */
            const handleUiAction = (action) => {
                if (action.filter_city) {
                    setActiveCity(action.filter_city);
                    setSelectedHotelId(null);
                }
                if (action.show_hotel_details) {
                    setSelectedHotelId(action.show_hotel_details);
                }
            };

            const filteredHotels = activeCity === "All"
                ? hotels
                : hotels.filter(h => h.city.toLowerCase() === activeCity.toLowerCase());

            const cities = ["All", ...new Set(hotels.map(h => h.city))];
            const selectedHotel = hotels.find(h => h.id === selectedHotelId);

            return (
                <div className="min-h-screen pb-32">
                    {/* Top bar: logo (click = back to all hotels) */}
                    <nav className="bg-white border-b border-gray-200 sticky top-0 z-40">
                        <div className="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
                            <div className="text-xl font-bold text-gray-900 flex items-center gap-2 cursor-pointer" onClick={() => { setSelectedHotelId(null); setActiveCity("All"); }}>
                                <i className="ph-fill ph-buildings text-slate-600"></i> Sahar Stays
                            </div>
                        </div>
                    </nav>

                    {/* Hero: title, subtitle, "Ask AI Concierge" button (only when not on hotel details) */}
                    {!selectedHotelId && (
                        <div className="relative h-[400px] flex items-center justify-center text-center px-4 bg-white border-b border-gray-200">
                            <div className="relative z-10 max-w-4xl">
                                <h1 className="text-4xl font-bold mb-4 tracking-tight text-gray-900">Find Your Perfect Stay</h1>
                                <p className="text-lg text-gray-600 mb-8">Discover luxury hotels in {cities.slice(1).join(", ")}.</p>
                                <button
                                    onClick={() => setIsChatOpen(true)}
                                    className="bg-slate-800 text-white px-6 py-3 rounded-xl text-base font-semibold hover:bg-slate-700 transition-all inline-flex items-center gap-2"
                                >
                                    <i className="ph-fill ph-sparkle"></i>
                                    Ask AI Concierge
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Main content: either hotel details page or city filter + hotel grid */}
                    {selectedHotelId && selectedHotel ? (
                        <HotelDetails
                            hotel={selectedHotel}
                            onBack={() => setSelectedHotelId(null)}
                            onBook={handleBookClick}
                        />
                    ) : (
                        <div className="max-w-7xl mx-auto px-6 py-12">
                            {/* City pills: All, Paris, Marrakech, etc. */}
                            <div className="flex gap-2 overflow-x-auto pb-6 mb-8">
                                {cities.map(city => (
                                    <button
                                        key={city}
                                        onClick={() => setActiveCity(city)}
                                        className={`px-5 py-2.5 rounded-lg text-sm font-medium whitespace-nowrap transition-all ${activeCity === city
                                            ? 'bg-slate-800 text-white'
                                            : 'bg-white border border-gray-200 text-gray-700 hover:bg-gray-50'
                                            }`}
                                    >
                                        {city}
                                    </button>
                                ))}
                            </div>

                            <div className="flex items-end justify-between mb-10">
                                <div>
                                    <h2 className="text-2xl font-bold text-gray-900 mb-1">{activeCity === 'All' ? 'All Destinations' : activeCity}</h2>
                                    <p className="text-gray-600">{filteredHotels.length} properties found</p>
                                </div>
                            </div>

                            {filteredHotels.length === 0 ? (
                                <div className="text-center py-32 text-gray-500 text-lg">
                                    {hotels.length === 0 ? 'Loading hotels...' : 'No hotels found in this city.'}
                                </div>
                            ) : (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                                    {filteredHotels.map((hotel, idx) => (
                                        <div key={hotel.id} style={{ animationDelay: `${idx * 0.1}s` }}>
                                            <HotelCard
                                                hotel={hotel}
                                                onBook={handleBookClick}
                                                onViewDetails={(h) => setSelectedHotelId(h.id)}
                                            />
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}

                    {/* Toggle chat: bottom-right floating button (X when open, chat icon when closed) */}
                    <button
                        onClick={() => setIsChatOpen(!isChatOpen)}
                        className={`fixed bottom-6 right-6 w-14 h-14 rounded-full shadow-lg flex items-center justify-center transition-all z-50 hover:bg-slate-700 ${isChatOpen ? 'bg-slate-600 text-white rotate-45' : 'bg-slate-800 text-white'}`}
                    >
                        {isChatOpen ? <i className="ph-bold ph-x text-2xl"></i> : <i className="ph-fill ph-chat-teardrop-dots text-2xl"></i>}
                    </button>

                    {/* Chat panel: receives ui_action and passes to handleUiAction */}
                    <ChatWidget
                        isOpen={isChatOpen}
                        onClose={() => setIsChatOpen(false)}
                        initialMessage={pendingMessage}
                        onMessageSent={() => setPendingMessage("")}
                        onUiAction={handleUiAction}
                    />
                </div>
            );
        }

        // Mount the React app into #root
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>